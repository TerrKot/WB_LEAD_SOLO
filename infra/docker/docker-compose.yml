services:
  network_init:
    image: docker:latest
    container_name: wb_lead_network_init
    command: >
      sh -c "
      apk add --no-cache docker-cli >/dev/null 2>&1 &&
      if ! docker network inspect docker_wb_lead_network >/dev/null 2>&1; then
        docker network create docker_wb_lead_network;
      fi &&
      docker network connect docker_wb_lead_network docker-redis-1 2>/dev/null || true &&
      docker network connect docker_wb_lead_network docker-postgres-1 2>/dev/null || true &&
      echo 'Network initialized: Redis and PostgreSQL connected'
      "
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: "no"
    network_mode: "host"

  bot_service:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: wb_lead_bot_service
    env_file:
      - ../../.env
    ports:
      - "8443:8444"
    restart: unless-stopped
    stop_grace_period: 10s
    stop_signal: SIGTERM
    command: ["python", "apps/bot_service/main.py"]
    networks:
      - wb_lead_network
    environment:
      - DATABASE_URL=postgresql+asyncpg://app:app@docker-postgres-1:5432/app
    depends_on:
      network_init:
        condition: service_completed_successfully

  worker:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: wb_lead_worker
    env_file:
      - ../../.env
    restart: unless-stopped
    stop_grace_period: 10s
    stop_signal: SIGTERM
    command: ["python", "apps/bot_service/workers/calculation_worker.py"]
    networks:
      - wb_lead_network
    environment:
      - DATABASE_URL=postgresql+asyncpg://app:app@docker-postgres-1:5432/app
    depends_on:
      network_init:
        condition: service_completed_successfully

networks:
  wb_lead_network:
    name: docker_wb_lead_network
    driver: bridge
    external: false
